<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Complete Japanese Kana Practice / 完整日文五十音練習器</title>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CR8D4QH6FF"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-CR8D4QH6FF');
    </script>
    <!-- End Google Analytics -->
    <style>
        body { 
            font-family: "Helvetica", "Yu Gothic", sans-serif; 
            text-align: center; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .page-content {
            display: block;
        }
        .page-content.hidden {
            display: none;
        }
        .container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; margin-bottom: 30px; }
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }
        .nav-tab {
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 8px;
            margin: 0 5px;
            transition: all 0.3s;
            font-weight: 500;
        }
        .nav-tab.active {
            background: #667eea;
            color: white;
        }
        .nav-tab:hover {
            background: #e9ecef;
        }
        .nav-tab.active:hover {
            background: #5a6fd8;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        input, button, select { 
            padding: 12px; 
            font-size: 16px; 
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 5px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        .kana { 
            font-size: 72px; 
            margin: 20px; 
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .result { 
            font-size: 18px; 
            margin-top: 20px; 
            font-weight: 500;
        }
        .quiz-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 30px; 
            margin-top: 30px; 
        }
        .mode-select { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .mode-select label { 
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .mode-select label:hover {
            background: #e9ecef;
        }
        .checkbox-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; 
            margin: 20px 0;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .checkbox-group { 
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .checkbox-group:hover {
            border-color: #667eea;
        }
        .checkbox-group h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 16px;
        }
        .checkbox-group label { 
            display: block;
            margin: 8px 0;
            text-align: left;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .checkbox-group label:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        .chart-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .chart-table th, .chart-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .chart-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        .chart-table td {
            font-size: 18px;
            transition: background 0.2s;
        }
        .chart-table td:hover {
            background: #f8f9fa;
        }
        .kana-char {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .romaji {
            font-size: 14px;
            color: #666;
            font-family: monospace;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            min-width: 120px;
            margin: 5px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        @media (max-width: 768px) {
            .container { margin: 10px; padding: 20px; }
            .kana { font-size: 48px; }
            .checkbox-grid { grid-template-columns: 1fr; }
            .quiz-container { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="title">🎌 日文五十音練習器</h1>
        <p style="margin: -10px 0 20px 0; color: #666; font-size: 14px;">作者: Ingee</p>

        <!-- 語言選擇 -->
        <div style="margin-bottom: 20px;">
            <label for="language">🌐 語言 Language:</label>
            <select id="language">
                <option value="zh">繁體中文</option>
                <option value="en">English</option>
            </select>
        </div>

        <!-- 導航標籤 -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="practice">
                <span id="nav-practice">練習模式</span>
            </div>
            <div class="nav-tab" data-tab="chart">
                <span id="nav-chart">五十音表</span>
            </div>
        </div>

        <!-- 練習模式標籤內容 -->
        <div id="practice-tab" class="tab-content active">
            <!-- 假名類型選擇 -->
            <div class="mode-select">
                <label>
                    <input type="radio" name="kana-type" value="hiragana" checked>
                    <span id="type-hiragana">平假名 (ひらがな)</span>
                </label>
                <label>
                    <input type="radio" name="kana-type" value="katakana">
                    <span id="type-katakana">片假名 (カタカナ)</span>
                </label>
                <label>
                    <input type="radio" name="kana-type" value="mixed">
                    <span id="type-mixed">混合練習</span>
                </label>
            </div>

            <!-- 練習範圍選擇 -->
            <div class="checkbox-grid">
                <div class="checkbox-group">
                    <h4 id="group-basic">基本音</h4>
                    <label><input type="checkbox" name="category" value="basic" checked> <span id="cat-basic">清音 (五十音)</span></label>
                </div>
                <div class="checkbox-group">
                    <h4 id="group-dakuten">濁音</h4>
                    <label><input type="checkbox" name="category" value="dakuten"> <span id="cat-dakuten">濁音 (が,ざ,だ,ば)</span></label>
                </div>
                <div class="checkbox-group">
                    <h4 id="group-handakuten">半濁音</h4>
                    <label><input type="checkbox" name="category" value="handakuten"> <span id="cat-handakuten">半濁音 (ぱ行)</span></label>
                </div>
                <div class="checkbox-group">
                    <h4 id="group-youon">拗音</h4>
                    <label><input type="checkbox" name="category" value="youon"> <span id="cat-youon">拗音 (きゃ,しゃ,ちゃ...)</span></label>
                </div>
            </div>

            <button id="start-btn">開始練習</button>

            <!-- 測驗區域 -->
            <div id="quiz-area" style="display: none;">
                <!-- 進度條 -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progress"></div>
                </div>
                
                <!-- 統計資訊 -->
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="current-num">1</div>
                        <div class="stat-label" id="stat-current">當前題目</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-num">0</div>
                        <div class="stat-label" id="stat-total">總題數</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="score-num">0</div>
                        <div class="stat-label" id="stat-score">正確數</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="accuracy">0%</div>
                        <div class="stat-label" id="stat-accuracy">正確率</div>
                    </div>
                </div>

                <!-- 測驗區 -->
                <div class="quiz-container">
                    <div class="kana" id="kana"></div>
                    <input id="answer" placeholder="輸入羅馬拼音">
                    <button id="submit-btn">送出</button>
                    <div class="result" id="feedback"></div>
                    <img src="咖波種子.gif" alt="咖波種子 GIF" style="width:300px; height:auto; margin-top: 20px;">
                </div>
            </div>
        </div>

        <!-- 五十音表標籤內容 -->
        <div id="chart-tab" class="tab-content">
            <div class="mode-select">
                <label>
                    <input type="radio" name="chart-type" value="hiragana" checked>
                    <span id="chart-hiragana-label">平假名</span>
                </label>
                <label>
                    <input type="radio" name="chart-type" value="katakana">
                    <span id="chart-katakana-label">片假名</span>
                </label>
            </div>
            <div id="kana-chart"></div>
            
            <!-- 概念展示區 -->
            <div style="margin: 30px 0;">
                <div class="checkbox-grid" style="pointer-events: none;">
                    <div class="checkbox-group" style="background: #f0f4ff; border: 2px solid #667eea;">
                        <h4 id="group-sokuon">促音</h4>
                        <p style="font-size: 14px; color: #666; margin: 5px 0; text-align: left;" id="sokuon-desc">
                            小つ (っ)，發音時停頓一拍<br>
                            例：きっぷ (kippu)、がっこう (gakkou)
                        </p>
                    </div>
                    <div class="checkbox-group" style="background: #f0f4ff; border: 2px solid #667eea;">
                        <h4 id="group-chouon">長音</h4>
                        <p style="font-size: 14px; color: #666; margin: 5px 0; text-align: left;" id="chouon-desc">
                            母音延長，持續兩拍<br>
                            例：おかあさん (okaasan)、コーヒー (koohii)
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // 完整的假名數據
    const kanaData = {
        basic: {
            hiragana: [
                ["あ","a"],["い","i"],["う","u"],["え","e"],["お","o"],
                ["か","ka"],["き","ki"],["く","ku"],["け","ke"],["こ","ko"],
                ["さ","sa"],["し","shi"],["す","su"],["せ","se"],["そ","so"],
                ["た","ta"],["ち","chi"],["つ","tsu"],["て","te"],["と","to"],
                ["な","na"],["に","ni"],["ぬ","nu"],["ね","ne"],["の","no"],
                ["は","ha"],["ひ","hi"],["ふ","fu"],["へ","he"],["ほ","ho"],
                ["ま","ma"],["み","mi"],["む","mu"],["め","me"],["も","mo"],
                ["や","ya"],["ゆ","yu"],["よ","yo"],
                ["ら","ra"],["り","ri"],["る","ru"],["れ","re"],["ろ","ro"],
                ["わ","wa"],["を","wo"],["ん","n"]
            ],
            katakana: [
                ["ア","a"],["イ","i"],["ウ","u"],["エ","e"],["オ","o"],
                ["カ","ka"],["キ","ki"],["ク","ku"],["ケ","ke"],["コ","ko"],
                ["サ","sa"],["シ","shi"],["ス","su"],["セ","se"],["ソ","so"],
                ["タ","ta"],["チ","chi"],["ツ","tsu"],["テ","te"],["ト","to"],
                ["ナ","na"],["ニ","ni"],["ヌ","nu"],["ネ","ne"],["ノ","no"],
                ["ハ","ha"],["ヒ","hi"],["フ","fu"],["ヘ","he"],["ホ","ho"],
                ["マ","ma"],["ミ","mi"],["ム","mu"],["メ","me"],["モ","mo"],
                ["ヤ","ya"],["ユ","yu"],["ヨ","yo"],
                ["ラ","ra"],["リ","ri"],["ル","ru"],["レ","re"],["ロ","ro"],
                ["ワ","wa"],["ヲ","wo"],["ン","n"]
            ]
        },
        dakuten: {
            hiragana: [
                ["が","ga"],["ぎ","gi"],["ぐ","gu"],["げ","ge"],["ご","go"],
                ["ざ","za"],["じ","ji/zi"],["ず","zu"],["ぜ","ze"],["ぞ","zo"],
                ["だ","da"],["ぢ","di/ji"],["づ","du/zu"],["で","de"],["ど","do"],
                ["ば","ba"],["び","bi"],["ぶ","bu"],["べ","be"],["ぼ","bo"]
            ],
            katakana: [
                ["ガ","ga"],["ギ","gi"],["グ","gu"],["ゲ","ge"],["ゴ","go"],
                ["ザ","za"],["ジ","ji/zi"],["ズ","zu"],["ゼ","ze"],["ゾ","zo"],
                ["ダ","da"],["ヂ","di/ji"],["ヅ","du/zu"],["デ","de"],["ド","do"],
                ["バ","ba"],["ビ","bi"],["ブ","bu"],["ベ","be"],["ボ","bo"]
            ]
        },
        handakuten: {
            hiragana: [
                ["ぱ","pa"],["ぴ","pi"],["ぷ","pu"],["ぺ","pe"],["ぽ","po"]
            ],
            katakana: [
                ["パ","pa"],["ピ","pi"],["プ","pu"],["ペ","pe"],["ポ","po"]
            ]
        },
        youon: {
            hiragana: [
                ["きゃ","kya"],["きゅ","kyu"],["きょ","kyo"],
                ["しゃ","sha"],["しゅ","shu"],["しょ","sho"],
                ["ちゃ","cha"],["ちゅ","chu"],["ちょ","cho"],
                ["にゃ","nya"],["にゅ","nyu"],["にょ","nyo"],
                ["ひゃ","hya"],["ひゅ","hyu"],["ひょ","hyo"],
                ["みゃ","mya"],["みゅ","myu"],["みょ","myo"],
                ["りゃ","rya"],["りゅ","ryu"],["りょ","ryo"],
                ["ぎゃ","gya"],["ぎゅ","gyu"],["ぎょ","gyo"],
                ["じゃ","ja"],["じゅ","ju"],["じょ","jo"],
                ["ぢゃ","dya"],["ぢゅ","dyu"],["ぢょ","dyo"],
                ["びゃ","bya"],["びゅ","byu"],["びょ","byo"],
                ["ぴゃ","pya"],["ぴゅ","pyu"],["ぴょ","pyo"]
            ],
            katakana: [
                ["キャ","kya"],["キュ","kyu"],["キョ","kyo"],
                ["シャ","sha"],["シュ","shu"],["ショ","sho"],
                ["チャ","cha"],["チュ","chu"],["チョ","cho"],
                ["ニャ","nya"],["ニュ","nyu"],["ニョ","nyo"],
                ["ヒャ","hya"],["ヒュ","hyu"],["ヒョ","hyo"],
                ["ミャ","mya"],["ミュ","myu"],["ミョ","myo"],
                ["リャ","rya"],["リュ","ryu"],["リョ","ryo"],
                ["ギャ","gya"],["ギュ","gyu"],["ギョ","gyo"],
                ["ジャ","ja"],["ジュ","ju"],["ジョ","jo"],
                ["ヂャ","dya"],["ヂュ","dyu"],["ヂョ","dyo"],
                ["ビャ","bya"],["ビュ","byu"],["ビョ","byo"],
                ["ピャ","pya"],["ピュ","pyu"],["ピョ","pyo"]
            ]
        }
    };

    // 五十音表數據
    const chartData = {
        basic: [
            ["","a","i","u","e","o"],
            ["","あ/ア","い/イ","う/ウ","え/エ","お/オ"],
            ["k","か/カ","き/キ","く/ク","け/ケ","こ/コ"],
            ["s","さ/サ","し/シ","す/ス","せ/セ","そ/ソ"],
            ["t","た/タ","ち/チ","つ/ツ","て/テ","と/ト"],
            ["n","な/ナ","に/ニ","ぬ/ヌ","ね/ネ","の/ノ"],
            ["h","は/ハ","ひ/ヒ","ふ/フ","へ/ヘ","ほ/ホ"],
            ["m","ま/マ","み/ミ","む/ム","め/メ","も/モ"],
            ["y","や/ヤ","","ゆ/ユ","","よ/ヨ"],
            ["r","ら/ラ","り/リ","る/ル","れ/レ","ろ/ロ"],
            ["w","わ/ワ","","","","を/ヲ (wo/o)"],
            ["","","","","","ん/ン"]
        ],
        dakuten: [
            ["","a","i","u","e","o"],
            ["g","が/ガ","ぎ/ギ","ぐ/グ","げ/ゲ","ご/ゴ"],
            ["z","ざ/ザ","じ/ジ (ji/zi)","ず/ズ","ぜ/ゼ","ぞ/ゾ"],
            ["d","だ/ダ","ぢ/ヂ (di/ji)","づ/ヅ (du/zu)","で/デ","ど/ド"],
            ["b","ば/バ","び/ビ","ぶ/ブ","べ/ベ","ぼ/ボ"]
        ],
        handakuten: [
            ["","a","i","u","e","o"],
            ["p","ぱ/パ","ぴ/ピ","ぷ/プ","ぺ/ペ","ぽ/ポ"]
        ]
    };

    let selected = [], current = 0, score = 0, total = 0, lang = "zh";

    const texts = {
        zh: {
            title: "🎌 日文五十音練習器",
            navPractice: "練習模式",
            navChart: "五十音表",
            typeHiragana: "平假名 (ひらがな)",
            typeKatakana: "片假名 (カタカナ)",
            typeMixed: "混合練習",
            groupBasic: "基本音",
            groupDakuten: "濁音",
            groupHandakuten: "半濁音",
            groupYouon: "拗音",
            groupSokuon: "促音",
            groupChouon: "長音",
            sokuonDesc: "小つ (っ)，發音時停頓一拍<br>例：きっぷ (kippu)、がっこう (gakkou)",
            chouonDesc: "母音延長，持續兩拍<br>例：おかあさん (okaasan)、コーヒー (koohii)",
            backBtn: "返回主選單",
            quizTitle: "練習模式",
            catBasic: "清音",
            catDakuten: "濁音 (が,ざ,だ,ば)",
            catHandakuten: "半濁音 (ぱ行)",
            catYouon: "拗音 (きゃ,しゃ,ちゃ...)",
            catSokuon: "促音 (きっぷ,がっこう...)",
            catChouon: "長音 (おかあさん,コーヒー...)",
            catBasicKatakana: "清音",
            catDakutenKatakana: "濁音 (ガ,ザ,ダ,バ)",
            catHandakutenKatakana: "半濁音 (パ行)",
            catYouonKatakana: "拗音 (キャ,シャ,チャ...)",
            catSokuonKatakana: "促音 (チケット,サッカー...)",
            catChouonKatakana: "長音 (コーヒー,ケーキ...)",
            startBtn: "開始練習",
            submitBtn: "送出",
            correct: "✅ 正確！",
            wrong: c => `❌ 錯誤，正確答案是 ${c}`,
            finalScore: (s, t) => `🌟 練習完成！得分：${s} / ${t} (${Math.round(s/t*100)}%)`,
            alert: "⚠️ 請至少選擇一種練習類型！",
            statCurrent: "當前題目",
            statTotal: "總題數",
            statScore: "正確數",
            statAccuracy: "正確率",
            answerPlaceholder: "輸入羅馬拼音",
            chartHiragana: "平假名",
            chartKatakana: "片假名"
        },
        en: {
            title: "🎌 50 Sounds Practice",
            navPractice: "Practice Mode",
            navChart: "Kana Chart",
            typeHiragana: "Hiragana (ひらがな)",
            typeKatakana: "Katakana (カタカナ)",
            typeMixed: "Mixed Practice",
            groupBasic: "Basic",
            groupDakuten: "Dakuon",
            groupHandakuten: "Handakuon",
            groupYouon: "Youon",
            groupSokuon: "Sokuon",
            groupChouon: "Long Vowels",
            sokuonDesc: "Small tsu (っ), pause for one beat<br>Ex: きっぷ (kippu), がっこう (gakkou)",
            chouonDesc: "Extended vowels, hold for two beats<br>Ex: おかあさん (okaasan), コーヒー (koohii)",
            backBtn: "Back to Menu",
            quizTitle: "Practice Mode",
            catBasic: "Clear sounds",
            catDakuten: "Voiced sounds (ga,za,da,ba)",
            catHandakuten: "Semi-voiced sounds (pa)",
            catYouon: "Contracted sounds (kya,sha,cha...)",
            catSokuon: "Double consonants (kippu,gakkou...)",
            catChouon: "Long vowels (okaasan,koohii...)",
            catBasicKatakana: "Clear sounds",
            catDakutenKatakana: "Voiced sounds (GA,ZA,DA,BA)",
            catHandakutenKatakana: "Semi-voiced sounds (PA)",
            catYouonKatakana: "Contracted sounds (KYA,SHA,CHA...)",
            catSokuonKatakana: "Double consonants (chiketto,sakkaa...)",
            catChouonKatakana: "Long vowels (koohii,keeki...)",
            startBtn: "Start Practice",
            submitBtn: "Submit",
            correct: "✅ Correct!",
            wrong: c => `❌ Incorrect, correct answer: ${c}`,
            finalScore: (s, t) => `🌟 Practice Complete! Score: ${s} / ${t} (${Math.round(s/t*100)}%)`,
            alert: "⚠️ Please select at least one practice type!",
            statCurrent: "Current",
            statTotal: "Total",
            statScore: "Correct",
            statAccuracy: "Accuracy",
            answerPlaceholder: "Enter romaji",
            chartHiragana: "Hiragana",
            chartKatakana: "Katakana"
        }
    };

    function setLanguage() {
        console.log("setLanguage called");
        lang = document.getElementById("language").value;
        console.log("Language set to:", lang);
        const t = texts[lang];
        
        try {
            document.getElementById("title").innerText = t.title;
            
            // 更新作者信息
            const authorElement = document.querySelector('p');
            if (authorElement) {
                if (lang === 'zh') {
                    authorElement.innerText = "作者: Ingee";
                } else {
                    authorElement.innerText = "Author: Ingee";
                }
            }
            
            // 更新導航標籤
            const navPracticeEl = document.getElementById("nav-practice");
            if (navPracticeEl) navPracticeEl.innerText = t.navPractice;
            
            const navChartEl = document.getElementById("nav-chart");
            if (navChartEl) navChartEl.innerText = t.navChart;
            
            // 更新假名類型標籤
            const typeHiraganaEl = document.getElementById("type-hiragana");
            if (typeHiraganaEl) typeHiraganaEl.innerText = t.typeHiragana;
            
            const typeKatakanaEl = document.getElementById("type-katakana");
            if (typeKatakanaEl) typeKatakanaEl.innerText = t.typeKatakana;
            
            const typeMixedEl = document.getElementById("type-mixed");
            if (typeMixedEl) typeMixedEl.innerText = t.typeMixed;
            
            // 更新分組標籤
            const groupBasicEl = document.getElementById("group-basic");
            if (groupBasicEl) groupBasicEl.innerText = t.groupBasic;
            
            const groupDakutenEl = document.getElementById("group-dakuten");
            if (groupDakutenEl) groupDakutenEl.innerText = t.groupDakuten;
            
            const groupHandakutenEl = document.getElementById("group-handakuten");
            if (groupHandakutenEl) groupHandakutenEl.innerText = t.groupHandakuten;
            
            const groupYouonEl = document.getElementById("group-youon");
            if (groupYouonEl) groupYouonEl.innerText = t.groupYouon;
            
            const groupSokuonEl = document.getElementById("group-sokuon");
            if (groupSokuonEl) groupSokuonEl.innerText = t.groupSokuon;
            
            const groupChouonEl = document.getElementById("group-chouon");
            if (groupChouonEl) groupChouonEl.innerText = t.groupChouon;
            
            // 更新描述文字
            const sokuonDescEl = document.getElementById("sokuon-desc");
            if (sokuonDescEl) sokuonDescEl.innerHTML = t.sokuonDesc;
            
            const chouonDescEl = document.getElementById("chouon-desc");
            if (chouonDescEl) chouonDescEl.innerHTML = t.chouonDesc;
            
            // 更新按鈕文字
            const backBtnEl = document.getElementById("back-btn");
            if (backBtnEl) backBtnEl.innerText = t.backBtn;
            
            const quizTitleEl = document.getElementById("quiz-title");
            if (quizTitleEl) quizTitleEl.innerText = t.quizTitle;
            
            // 更新類別標籤
            const catBasicEl = document.getElementById("cat-basic");
            if (catBasicEl) catBasicEl.innerText = t.catBasic;
            
            const catDakutenEl = document.getElementById("cat-dakuten");
            if (catDakutenEl) catDakutenEl.innerText = t.catDakuten;
            
            const catHandakutenEl = document.getElementById("cat-handakuten");
            if (catHandakutenEl) catHandakutenEl.innerText = t.catHandakuten;
            
            const catYouonEl = document.getElementById("cat-youon");
            if (catYouonEl) catYouonEl.innerText = t.catYouon;
            
            // 更新按鈕
            const startBtnEl = document.getElementById("start-btn");
            if (startBtnEl) startBtnEl.innerText = t.startBtn;
            
            const submitBtnEl = document.getElementById("submit-btn");
            if (submitBtnEl) submitBtnEl.innerText = t.submitBtn;
            
            // 更新統計標籤
            const statCurrentEl = document.getElementById("stat-current");
            if (statCurrentEl) statCurrentEl.innerText = t.statCurrent;
            
            const statTotalEl = document.getElementById("stat-total");
            if (statTotalEl) statTotalEl.innerText = t.statTotal;
            
            const statScoreEl = document.getElementById("stat-score");
            if (statScoreEl) statScoreEl.innerText = t.statScore;
            
            const statAccuracyEl = document.getElementById("stat-accuracy");
            if (statAccuracyEl) statAccuracyEl.innerText = t.statAccuracy;
            
            // 更新輸入框佔位符
            const answerEl = document.getElementById("answer");
            if (answerEl) answerEl.placeholder = t.answerPlaceholder;
            
            // 更新五十音表標籤
            const chartHiraEl = document.getElementById("chart-hiragana-label");
            if (chartHiraEl) chartHiraEl.innerText = t.chartHiragana;
            
            const chartKataEl = document.getElementById("chart-katakana-label");
            if (chartKataEl) chartKataEl.innerText = t.chartKatakana;
            
            console.log("Language updated successfully");
            updateChart();
        } catch (error) {
            console.error("Error in setLanguage:", error);
        }
    }

    function showTab(tabName) {
        console.log("showTab called with:", tabName);
        
        // 先隱藏所有 tab-content
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
            tab.style.display = 'none';
        });
        // 先移除所有 nav-tab 的 active
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

        // 顯示對應 tab
        const currentTab = document.getElementById(tabName + '-tab');
        if (currentTab) {
            currentTab.classList.add('active');
            currentTab.style.display = 'block';
            console.log("Tab displayed:", tabName);
        } else {
            console.log("Tab not found:", tabName + '-tab');
        }
        
        // 對應 nav-tab 加 active
        const activeNavTab = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
        if (activeNavTab) {
            activeNavTab.classList.add('active');
            console.log("Nav tab activated:", tabName);
        }

        // 控制「開始練習」按鈕顯示
        const startBtn = document.getElementById("start-btn");
        if (startBtn) {
            if (tabName === 'practice') {
                startBtn.style.display = "";
                startBtn.innerText = texts[lang].startBtn;
                console.log("Start button shown");
            } else {
                startBtn.style.display = "none";
                console.log("Start button hidden");
            }
        }

        if (tabName === 'chart') {
            updateChart();
            console.log("Chart updated");
        }
    }

    function updateKanaType() {
        // 假名類型更新時可以添加邏輯
    }

    function shuffle(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    function startQuiz() {
        console.log("startQuiz called");
        
        try {
            // 清理之前的練習狀態
            const existingQuizArea = document.getElementById("quiz-area");
            if (existingQuizArea) {
                existingQuizArea.style.display = "none";
            }
            const inlineQuiz = document.getElementById("inline-quiz");
            if (inlineQuiz) {
                inlineQuiz.remove();
            }
            const existingQuizHeader = document.getElementById("quiz-header");
            if (existingQuizHeader) {
                existingQuizHeader.remove();
            }
            
            const kanaTypeEl = document.querySelector('input[name="kana-type"]:checked');
            if (!kanaTypeEl) {
                console.log("No kana type selected");
                return;
            }
            
            const kanaType = kanaTypeEl.value;
            // 安全性改進：驗證 kanaType 值
            if (!['hiragana', 'katakana', 'mixed'].includes(kanaType)) {
                console.error("Invalid kana type:", kanaType);
                return;
            }
            
            const categories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(cb => cb.value);
            
            if (categories.length === 0) {
                alert(texts[lang].alert);
                return;
            }

            let kanaList = [];
            categories.forEach(category => {
                // 安全性改進：驗證 category 值
                if (kanaData[category] && ['basic', 'dakuten', 'handakuten', 'youon'].includes(category)) {
                    if (kanaType === 'mixed') {
                        if (kanaData[category].hiragana) kanaList.push(...kanaData[category].hiragana);
                        if (kanaData[category].katakana) kanaList.push(...kanaData[category].katakana);
                    } else {
                        if (kanaData[category][kanaType]) kanaList.push(...kanaData[category][kanaType]);
                    }
                }
            });

            if (kanaList.length === 0) {
                console.log("No kana data found");
                return;
            }

            selected = shuffle(kanaList);
            current = 0;
            score = 0;
            total = selected.length;
            
            // 進入練習模式 - 隱藏主選單內容，顯示練習內容
            const practiceTab = document.getElementById("practice-tab");
            const chartTab = document.getElementById("chart-tab");
            const navTabs = document.querySelector(".nav-tabs");
            const languageSelect = document.querySelector('div[style*="margin-bottom: 20px"]');
            
            console.log("Hiding menu elements...");
            
            if (practiceTab) {
                // 隱藏選項區域
                const checkboxGrid = practiceTab.querySelector(".checkbox-grid");
                const modeSelect = practiceTab.querySelector(".mode-select");
                const startBtn = document.getElementById("start-btn");
                
                if (checkboxGrid) {
                    checkboxGrid.style.display = "none";
                    console.log("Checkbox grid hidden");
                }
                if (modeSelect) {
                    modeSelect.style.display = "none";
                    console.log("Mode select hidden");
                }
                if (startBtn) {
                    startBtn.style.display = "none";
                    console.log("Start button hidden");
                }
                if (navTabs) {
                    navTabs.style.display = "none";
                    console.log("Nav tabs hidden");
                }
                if (chartTab) {
                    chartTab.style.display = "none";
                    console.log("Chart tab hidden");
                }
                if (languageSelect) {
                    languageSelect.style.display = "none";
                    console.log("Language select hidden");
                }
                
                // 創建練習頁面頂部導航
                let quizHeader = document.createElement("div");
                quizHeader.id = "quiz-header";
                quizHeader.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 15px; background: rgba(255,255,255,0.9); border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);";
                
                const backButton = document.createElement("button");
                backButton.innerHTML = "← " + texts[lang].backBtn;
                backButton.style.cssText = "background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;";
                backButton.onclick = returnToMenu;
                
                const title = document.createElement("h2");
                title.style.cssText = "margin: 0; color: #2c3e50;";
                title.innerText = texts[lang].quizTitle;
                
                const spacer = document.createElement("div");
                spacer.style.width = "120px";
                
                quizHeader.appendChild(backButton);
                quizHeader.appendChild(title);
                quizHeader.appendChild(spacer);
                
                practiceTab.insertBefore(quizHeader, practiceTab.firstChild);
                console.log("Quiz header created");
            }
            
            // 強制顯示測驗內容
            console.log("Force showing quiz content...");
            
            // 直接在這裡顯示測驗區域
            const quizArea = document.getElementById("quiz-area");
            console.log("Direct quiz area check:", quizArea);
            
            if (quizArea) {
                quizArea.style.display = "block";
                quizArea.style.visibility = "visible";
                quizArea.style.opacity = "1";
                quizArea.style.position = "relative";
                quizArea.style.zIndex = "1000";
                quizArea.style.backgroundColor = "rgba(255,255,255,0.95)";
                quizArea.style.padding = "20px";
                quizArea.style.borderRadius = "10px";
                quizArea.style.marginTop = "20px";
                console.log("Quiz area shown directly with enhanced styles");
            } else {
                console.log("Quiz area NOT found - creating inline");
                // 直接創建測驗內容 - 使用安全的 DOM API
                const practiceTab = document.getElementById("practice-tab");
                if (practiceTab) {
                    const inlineQuiz = document.createElement("div");
                    inlineQuiz.id = "inline-quiz";
                    
                    // 使用安全的 DOM API 而不是 innerHTML
                    const kanaDiv = document.createElement("div");
                    kanaDiv.id = "kana";
                    kanaDiv.style.cssText = "font-size: 72px; margin: 20px; color: #2c3e50; text-align: center;";
                    
                    const containerDiv = document.createElement("div");
                    containerDiv.style.cssText = "text-align: center; margin: 20px;";
                    
                    const answerInput = document.createElement("input");
                    answerInput.id = "answer";
                    answerInput.placeholder = "輸入羅馬拼音";
                    answerInput.style.cssText = "padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; margin: 5px;";
                    // 不要在這裡加事件監聽
                    
                    const submitBtn = document.createElement("button");
                    submitBtn.id = "submit-btn";
                    submitBtn.textContent = "送出";
                    submitBtn.style.cssText = "padding: 12px 24px; font-size: 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;";
                    // 不要在這裡加事件監聽
                    
                    const feedbackDiv = document.createElement("div");
                    feedbackDiv.id = "feedback";
                    feedbackDiv.style.cssText = "font-size: 18px; margin: 20px; font-weight: 500;";
                    
                    const img = document.createElement("img");
                    img.src = "咖波種子.gif";
                    img.alt = "咖波種子 GIF";
                    img.style.cssText = "width:300px; height:auto; margin-top: 20px;";
                    
                    // 組裝 DOM 結構
                    containerDiv.appendChild(answerInput);
                    containerDiv.appendChild(document.createElement("br"));
                    containerDiv.appendChild(document.createElement("br"));
                    containerDiv.appendChild(submitBtn);
                    containerDiv.appendChild(feedbackDiv);
                    containerDiv.appendChild(img);
                    
                    inlineQuiz.appendChild(kanaDiv);
                    inlineQuiz.appendChild(containerDiv);
                    
                    practiceTab.appendChild(inlineQuiz);
                    console.log("Inline quiz created using safe DOM API");
                    
                    // 重新設置事件監聽器（因為新創建的元素）
                    setupQuizEventListeners();
                }
            }
            
            const totalNumEl = document.getElementById("total-num");
            if (totalNumEl) {
                totalNumEl.innerText = total;
                console.log("Total number set to:", total);
            }
            
            console.log("Calling updateStats...");
            updateStats();
            console.log("Calling nextQuestion...");
            nextQuestion();
            console.log("Quiz started successfully");
            showQuizContent();
        } catch (error) {
            console.error("Error in startQuiz:", error);
            alert("發生錯誤，請重新整理頁面");
        }
    }

    function showQuizContent() {
        // 確保所有練習相關的元素都顯示
        const elementsToShow = [
            "progress", "current-num", "total-num", "score-num", "accuracy",
            "stat-current", "stat-total", "stat-score", "stat-accuracy",
            "kana", "answer", "submit-btn", "feedback"
        ];
        
        elementsToShow.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = "";
            }
        });
        
        // 確保進度條容器顯示
        const progressBar = document.querySelector(".progress-bar");
        if (progressBar) progressBar.style.display = "block";
        
        // 確保統計區域顯示
        const stats = document.querySelector(".stats");
        if (stats) stats.style.display = "flex";
        
        // 確保測驗容器顯示
        const quizContainer = document.querySelector(".quiz-container");
        if (quizContainer) quizContainer.style.display = "flex";
        
        // 確保咖波種子顯示
        const kaboImg = document.querySelector('img[alt="咖波種子 GIF"]');
        if (kaboImg) {
            kaboImg.style.display = "block";
        }
    }

    function returnToMenu() {
        console.log("Returning to menu...");
        
        // 返回主選單 - 顯示主選單內容，隱藏練習內容
        const practiceTab = document.getElementById("practice-tab");
        const chartTab = document.getElementById("chart-tab");
        const navTabs = document.querySelector(".nav-tabs");
        const languageSelect = document.querySelector('div[style*="margin-bottom: 20px"]');
        const quizHeader = document.getElementById("quiz-header");
        
        if (practiceTab) {
            // 顯示選項區域
            const checkboxGrid = practiceTab.querySelector(".checkbox-grid");
            const modeSelect = practiceTab.querySelector(".mode-select");
            const startBtn = document.getElementById("start-btn");
            
            if (checkboxGrid) {
                checkboxGrid.style.display = "";
                console.log("Checkbox grid restored");
            }
            if (modeSelect) {
                modeSelect.style.display = "";
                console.log("Mode select restored");
            }
            if (startBtn) {
                startBtn.style.display = "";
                console.log("Start button restored");
            }
            if (navTabs) {
                navTabs.style.display = "";
                console.log("Nav tabs restored");
            }
            if (languageSelect) {
                languageSelect.style.display = "";
                console.log("Language select restored");
            }
            if (quizHeader) {
                quizHeader.style.display = "none";
                console.log("Quiz header hidden");
            }
        }
        
        // 修正：不要直接設 display: none，讓 tab 切換時自動管理
        if (chartTab) {
            chartTab.classList.remove('active');
            console.log("Chart tab reset (remove active class)");
        }
        
        // 隱藏測驗內容
        hideQuizContent();
        
        console.log("Returned to main menu");
    }

    function hideQuizContent() {
        // 隱藏 quiz-area
        const quizArea = document.getElementById("quiz-area");
        if (quizArea) quizArea.style.display = "none";

        // 隱藏進度條容器
        const progressBar = document.querySelector(".progress-bar");
        if (progressBar) progressBar.style.display = "none";
        
        // 隱藏統計區域
        const stats = document.querySelector(".stats");
        if (stats) stats.style.display = "none";
        
        // 隱藏測驗容器
        const quizContainer = document.querySelector(".quiz-container");
        if (quizContainer) quizContainer.style.display = "none";
        
        // 隱藏假名顯示
        const kanaEl = document.getElementById("kana");
        if (kanaEl) kanaEl.innerText = "";
        
        // 隱藏咖波種子
        const kaboImg = document.querySelector('img[alt="咖波種子 GIF"]');
        if (kaboImg) {
            kaboImg.style.display = "none";
        }
        
        // 清除反饋
        const feedbackEl = document.getElementById("feedback");
        if (feedbackEl) feedbackEl.innerText = "";
    }

    function updateStats() {
        const currentEl = document.getElementById("current-num");
        const scoreEl = document.getElementById("score-num");
        const accuracyEl = document.getElementById("accuracy");
        const progressEl = document.getElementById("progress");
        
        if (currentEl) currentEl.innerText = current + 1;
        if (scoreEl) scoreEl.innerText = score;
        if (accuracyEl) accuracyEl.innerText = current > 0 ? Math.round(score / current * 100) + "%" : "0%";
        
        if (progressEl) {
            const progress = ((current) / total) * 100;
            progressEl.style.width = progress + "%";
        }
    }

    function nextQuestion() {
        console.log("nextQuestion called, current:", current, "total:", total);
        
        const kanaEl = document.getElementById("kana");
        const answerEl = document.getElementById("answer");
        const submitBtnEl = document.getElementById("submit-btn");
        const feedbackEl = document.getElementById("feedback");
        
        console.log("Kana element:", kanaEl);
        console.log("Answer element:", answerEl);
        
        if (current >= selected.length) {
            if (kanaEl) {
                kanaEl.innerText = texts[lang].finalScore(score, total);
                console.log("Final score displayed");
            }
            if (answerEl) answerEl.style.display = "none";
            if (submitBtnEl) submitBtnEl.style.display = "none";
            if (feedbackEl) feedbackEl.innerText = "";
            return;
        }
        
        if (kanaEl) {
            kanaEl.innerText = selected[current][0];
            console.log("Current kana set to:", selected[current][0]);
        }
        if (answerEl) {
            answerEl.value = "";
            answerEl.style.display = "inline";
            setTimeout(() => answerEl.focus(), 100);
            console.log("Answer input reset and focused");
        }
        if (submitBtnEl) submitBtnEl.style.display = "inline";
        if (feedbackEl) feedbackEl.innerText = "";
        
        updateStats();
    }

    function checkAnswer() {
        const answerEl = document.getElementById("answer");
        const feedbackEl = document.getElementById("feedback");
        
        if (!answerEl || !feedbackEl) return;
        
        // 安全性改進：輸入驗證與清理
        let user = answerEl.value.trim().toLowerCase();
        
        // 防止 XSS 攻擊：移除危險字符
        user = user.replace(/[<>\"'&]/g, '');
        
        // 限制輸入長度
        if (user.length > 50) {
            user = user.substring(0, 50);
        }
        
        // 只允許字母、數字和基本符號
        if (!/^[a-zA-Z0-9\s\/\-]+$/.test(user)) {
            feedbackEl.innerText = "⚠️ 請只輸入有效的羅馬拼音";
            feedbackEl.style.color = "#e74c3c";
            return;
        }
        
        const char = selected[current][0];
        const correctAnswers = selected[current][1];
        
        // 處理多種讀音的情況
        let acceptableAnswers = [];
        if (correctAnswers.includes('/')) {
            acceptableAnswers = correctAnswers.split('/');
        } else {
            acceptableAnswers = [correctAnswers];
        }
        
        // 特殊情況處理
        if (char === "を" || char === "ヲ") {
            acceptableAnswers = ["wo", "o"];
        }
        if (char === "ぢ" || char === "ヂ") {
            acceptableAnswers = ["di", "ji"];
        }
        if (char === "づ" || char === "ヅ") {
            acceptableAnswers = ["du", "zu"];
        }
        if (char === "じ" || char === "ジ") {
            acceptableAnswers = ["ji", "zi"];
        }
        
        if (acceptableAnswers.includes(user)) {
            feedbackEl.innerText = texts[lang].correct;
            feedbackEl.style.color = "#27ae60";
            score++;
        } else {
            const answerDisplay = acceptableAnswers.length > 1 ? 
                acceptableAnswers.join(' / ') : acceptableAnswers[0];
            feedbackEl.innerText = texts[lang].wrong(answerDisplay);
            feedbackEl.style.color = "#e74c3c";
        }
        
        current++;
        setTimeout(nextQuestion, 1500);
    }

    function updateChart() {
        console.log("updateChart called");
        
        const chartType = document.querySelector('input[name="chart-type"]:checked');
        if (!chartType) {
            console.log("No chart type selected, defaulting to hiragana");
            // 如果找不到選中的類型，默認為平假名
            const hiraganaRadio = document.querySelector('input[name="chart-type"][value="hiragana"]');
            if (hiraganaRadio) hiraganaRadio.checked = true;
        }
        
        const selectedType = chartType ? chartType.value : 'hiragana';
        console.log("Chart type:", selectedType);
        
        const chartContainer = document.getElementById("kana-chart");
        console.log("Chart container:", chartContainer);
        
        if (!chartContainer) {
            console.log("Chart container not found!");
            return;
        }
        
        let html = "";
        
        // 基本音表
        html += "<h3>清音</h3>";
        html += createChartTable(chartData.basic, selectedType);
        
        // 濁音表
        html += "<h3>濁音</h3>";
        html += createChartTable(chartData.dakuten, selectedType);
        
        // 半濁音表
        html += "<h3>半濁音</h3>";
        html += createChartTable(chartData.handakuten, selectedType);
        
        // 拗音表
        html += "<h3>拗音</h3>";
        html += createYouonTable(selectedType);
        
        console.log("Generated HTML length:", html.length);
        console.log("HTML preview:", html.substring(0, 200) + "...");
        
        // 安全性改進：使用 textContent 而不是 innerHTML（如果可能）
        // 由於這裡需要 HTML 格式，我們確保內容是安全的
        chartContainer.innerHTML = html;
        console.log("Chart container updated");
    }

    function createChartTable(data, type) {
        console.log("createChartTable called with type:", type);
        console.log("Data:", data);
        
        let html = '<table class="chart-table" style="width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
        
        data.forEach((row, index) => {
            html += '<tr>';
            row.forEach((cell, cellIndex) => {
                const cellStyle = index === 0 ? 
                    'style="padding: 12px; text-align: center; border: 1px solid #e9ecef; background: #667eea; color: white; font-weight: 600;"' :
                    'style="padding: 12px; text-align: center; border: 1px solid #e9ecef; font-size: 18px;"';
                
                if (index === 0) {
                    html += `<th ${cellStyle}>${cell}</th>`;
                } else {
                    if (cellIndex === 0) {
                        html += `<th ${cellStyle}>${cell}</th>`;
                    } else {
                        if (cell === "") {
                            html += '<td style="padding: 12px; text-align: center; border: 1px solid #e9ecef;"></td>';
                        } else {
                            // 檢查是否包含括號（多種讀音）
                            if (cell.includes('(')) {
                                // 有括號的情況，直接顯示
                                const kanaChars = cell.split(' (')[0].split('/');
                                const displayChar = type === 'hiragana' ? kanaChars[0] : kanaChars[1];
                                const romajiPart = cell.split(' (')[1].replace(')', '');
                                html += `<td style="padding: 12px; text-align: center; border: 1px solid #e9ecef;">
                                    <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${displayChar}</div>
                                    <div style="font-size: 14px; color: #666; font-family: monospace;">${romajiPart}</div>
                                </td>`;
                            } else {
                                // 普通情況，查找羅馬字
                                const kanaChars = cell.split('/');
                                const displayChar = type === 'hiragana' ? kanaChars[0] : kanaChars[1];
                                const romaji = getRomajiForKana(displayChar);
                                html += `<td style="padding: 12px; text-align: center; border: 1px solid #e9ecef;">
                                    <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${displayChar}</div>
                                    <div style="font-size: 14px; color: #666; font-family: monospace;">${romaji}</div>
                                </td>`;
                            }
                        }
                    }
                }
            });
            html += '</tr>';
        });
        
        html += '</table>';
        console.log("Generated table HTML length:", html.length);
        return html;
    }

    function createYouonTable(type) {
        const youonGroups = [
            {name: "きゃ行", kana: ["きゃ/キャ", "きゅ/キュ", "きょ/キョ"], romaji: ["kya", "kyu", "kyo"]},
            {name: "しゃ行", kana: ["しゃ/シャ", "しゅ/シュ", "しょ/ショ"], romaji: ["sha", "shu", "sho"]},
            {name: "ちゃ行", kana: ["ちゃ/チャ", "ちゅ/チュ", "ちょ/チョ"], romaji: ["cha", "chu", "cho"]},
            {name: "にゃ行", kana: ["にゃ/ニャ", "にゅ/ニュ", "にょ/ニョ"], romaji: ["nya", "nyu", "nyo"]},
            {name: "ひゃ行", kana: ["ひゃ/ヒャ", "ひゅ/ヒュ", "ひょ/ヒョ"], romaji: ["hya", "hyu", "hyo"]},
            {name: "みゃ行", kana: ["みゃ/ミャ", "みゅ/ミュ", "みょ/ミョ"], romaji: ["mya", "myu", "myo"]},
            {name: "りゃ行", kana: ["りゃ/リャ", "りゅ/リュ", "りょ/リョ"], romaji: ["rya", "ryu", "ryo"]},
            {name: "ぎゃ行", kana: ["ぎゃ/ギャ", "ぎゅ/ギュ", "ぎょ/ギョ"], romaji: ["gya", "gyu", "gyo"]},
            {name: "じゃ行", kana: ["じゃ/ジャ", "じゅ/ジュ", "じょ/ジョ"], romaji: ["ja", "ju", "jo"]},
            {name: "びゃ行", kana: ["びゃ/ビャ", "びゅ/ビュ", "びょ/ビョ"], romaji: ["bya", "byu", "byo"]},
            {name: "ぴゃ行", kana: ["ぴゃ/ピャ", "ぴゅ/ピュ", "ぴょ/ピョ"], romaji: ["pya", "pyu", "pyo"]}
        ];

        let html = '<table class="chart-table">';
        html += '<tr><th>行</th><th>や段</th><th>ゆ段</th><th>よ段</th></tr>';
        
        youonGroups.forEach(group => {
            html += '<tr>';
            html += `<th>${group.name}</th>`;
            group.kana.forEach((kana, index) => {
                const kanaChars = kana.split('/');
                const displayChar = type === 'hiragana' ? kanaChars[0] : kanaChars[1];
                html += `<td>
                    <div class="kana-char">${displayChar}</div>
                    <div class="romaji">${group.romaji[index]}</div>
                </td>`;
            });
            html += '</tr>';
        });
        
        html += '</table>';
        return html;
    }

    function getRomajiForKana(kana) {
        // 查找假名對應的羅馬字
        for (const category in kanaData) {
            for (const type in kanaData[category]) {
                const found = kanaData[category][type].find(item => item[0] === kana);
                if (found) return found[1];
            }
        }
        return "";
    }

    // 初始化
    function initializePage() {
        setLanguage();
        updateChart();
        
        // 綁定所有事件監聽器
        setupEventListeners();
        
        console.log("Page initialized"); // 調試信息
    }
    
    // 設置所有事件監聽器
    function setupEventListeners() {
        console.log("Setting up event listeners...");
        
        // 開始練習按鈕
        const startBtn = document.getElementById("start-btn");
        if (startBtn) {
            // 移除舊的事件監聽器（如果有的話）
            startBtn.removeEventListener('click', startQuiz);
            startBtn.addEventListener('click', startQuiz);
            console.log("Start button event listener added");
        } else {
            console.log("Start button not found");
        }
        
        // 語言選擇
        const languageSelect = document.getElementById("language");
        if (languageSelect) {
            // 移除舊的事件監聽器（如果有的話）
            languageSelect.removeEventListener('change', setLanguage);
            languageSelect.addEventListener('change', setLanguage);
            console.log("Language select event listener added");
        } else {
            console.log("Language select not found");
        }
        
        // 導航標籤
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => {
            // 移除舊的事件監聽器（如果有的話）
            tab.removeEventListener('click', tabClickHandler);
            tab.addEventListener('click', tabClickHandler);
        });
        console.log("Nav tabs event listeners added:", navTabs.length);
        
        // 假名類型選擇
        const kanaTypeRadios = document.querySelectorAll('input[name="kana-type"]');
        kanaTypeRadios.forEach(radio => {
            // 移除舊的事件監聽器（如果有的話）
            radio.removeEventListener('change', updateCategoryLabels);
            radio.addEventListener('change', updateCategoryLabels);
        });
        console.log("Kana type radios event listeners added:", kanaTypeRadios.length);
        
        // 五十音表類型選擇
        const chartTypeRadios = document.querySelectorAll('input[name="chart-type"]');
        chartTypeRadios.forEach(radio => {
            // 移除舊的事件監聽器（如果有的話）
            radio.removeEventListener('change', updateChart);
            radio.addEventListener('change', updateChart);
        });
        console.log("Chart type radios event listeners added:", chartTypeRadios.length);
        
        // 答案輸入框和送出按鈕（這些可能在動態創建時才存在）
        setupQuizEventListeners();
        
        console.log("All event listeners set up successfully");
    }
    
    // 設置測驗相關的事件監聽器
    function setupQuizEventListeners() {
        // 答案輸入框
        const answerInput = document.getElementById("answer");
        if (answerInput) {
            // 移除舊的事件監聽器（如果有的話）
            answerInput.removeEventListener('keydown', answerKeydownHandler);
            answerInput.addEventListener('keydown', answerKeydownHandler);
            console.log("Answer input event listener added");
        }
        
        // 送出按鈕
        const submitBtn = document.getElementById("submit-btn");
        if (submitBtn) {
            // 移除舊的事件監聽器（如果有的話）
            submitBtn.removeEventListener('click', checkAnswer);
            submitBtn.addEventListener('click', checkAnswer);
            console.log("Submit button event listener added");
        }
    }
    
    // 導航標籤點擊處理器
    function tabClickHandler() {
        const tabName = this.getAttribute('data-tab');
        console.log("Tab clicked:", tabName);
        showTab(tabName);
    }
    
    // 答案輸入框按鍵處理器
    function answerKeydownHandler(event) {
        if (event.key === 'Enter') {
            console.log("Enter key pressed in answer input");
            checkAnswer();
        }
    }
    
    // 更新類別標籤
    function updateCategoryLabels() {
        const kanaType = document.querySelector('input[name="kana-type"]:checked').value;
        
        if (kanaType === 'katakana') {
            document.getElementById('cat-dakuten').textContent = '濁音 (ガ,ザ,ダ,バ)';
            document.getElementById('cat-handakuten').textContent = '半濁音 (パ行)';
            document.getElementById('cat-youon').textContent = '拗音 (キャ,シャ,チャ...)';
        } else {
            document.getElementById('cat-dakuten').textContent = '濁音 (が,ざ,だ,ば)';
            document.getElementById('cat-handakuten').textContent = '半濁音 (ぱ行)';
            document.getElementById('cat-youon').textContent = '拗音 (きゃ,しゃ,ちゃ...)';
        }
    }
    
    // 當頁面加載完成時初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        initializePage();
    }
    </script>
</body>
</html>
